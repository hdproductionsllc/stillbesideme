<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Review Your Proof | Still Beside Me</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Source+Sans+3:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/store.css">
  <style>
    .proof-page {
      max-width: 720px;
      margin: 0 auto;
      padding: var(--space-2xl) var(--space-md);
    }
    .proof-header {
      text-align: center;
      margin-bottom: var(--space-xl);
    }
    .proof-header h1 {
      font-family: var(--font-display);
      font-size: 2rem;
      font-weight: 400;
      margin-bottom: var(--space-xs);
    }
    .proof-header .subtitle {
      color: var(--color-muted);
      font-size: 1.05rem;
    }
    .proof-image-wrap {
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: var(--space-xl);
      box-shadow: var(--shadow-lg);
    }
    .proof-image-wrap img {
      display: block;
      width: 100%;
      height: auto;
    }
    .order-summary {
      background: var(--color-surface);
      border-radius: 12px;
      padding: var(--space-lg);
      margin-bottom: var(--space-xl);
    }
    .order-summary h2 {
      font-family: var(--font-display);
      font-size: 1.2rem;
      font-weight: 400;
      margin-bottom: var(--space-md);
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid rgba(0,0,0,0.06);
    }
    .detail-row:last-child { border-bottom: none; }
    .detail-label { color: var(--color-muted); }
    .detail-value { font-weight: 600; }
    .proof-actions {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
      margin-bottom: var(--space-xl);
    }
    .btn-approve {
      display: block;
      width: 100%;
      padding: 16px;
      background: var(--color-secondary);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 1.05rem;
      font-weight: 600;
      font-family: var(--font-body);
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .btn-approve:hover { opacity: 0.9; }
    .btn-approve:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-changes {
      display: block;
      width: 100%;
      padding: 14px;
      background: transparent;
      color: var(--color-muted);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 0.95rem;
      font-family: var(--font-body);
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }
    .btn-changes:hover {
      border-color: var(--color-muted);
      color: var(--color-primary);
    }
    .changes-form {
      display: none;
      margin-top: var(--space-md);
    }
    .changes-form.visible { display: block; }
    .changes-form textarea {
      width: 100%;
      min-height: 120px;
      padding: var(--space-md);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-family: var(--font-body);
      font-size: 0.95rem;
      resize: vertical;
      box-sizing: border-box;
    }
    .changes-form textarea:focus {
      outline: none;
      border-color: var(--color-secondary);
    }
    .btn-submit-changes {
      margin-top: var(--space-sm);
      padding: 12px 32px;
      background: var(--color-warm);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 0.95rem;
      font-weight: 600;
      font-family: var(--font-body);
      cursor: pointer;
    }
    .btn-submit-changes:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .result-message {
      text-align: center;
      padding: var(--space-xl);
      background: var(--color-surface);
      border-radius: 12px;
    }
    .result-message h2 {
      font-family: var(--font-display);
      font-size: 1.5rem;
      font-weight: 400;
      margin-bottom: var(--space-sm);
    }
    .result-message p {
      color: var(--color-muted);
      line-height: 1.6;
    }
    .result-icon {
      font-size: 2.5rem;
      margin-bottom: var(--space-sm);
    }
    .loading-state, .error-state {
      text-align: center;
      padding: var(--space-2xl);
      color: var(--color-muted);
    }
    .error-state { color: var(--color-error); }
    .previous-notes {
      background: var(--color-bg);
      border-left: 3px solid var(--color-warm);
      padding: var(--space-md);
      border-radius: 0 var(--radius) var(--radius) 0;
      margin-bottom: var(--space-lg);
      font-size: 0.9rem;
      color: var(--color-muted);
    }
    .previous-notes strong { color: var(--color-primary); }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <a href="/" class="site-logo">Still Beside Me</a>
    </div>
  </header>

  <main class="proof-page" id="proofPage">
    <div class="loading-state" id="loading">Loading your proof...</div>
  </main>

  <script>
  (function() {
    const container = document.getElementById('proofPage');
    const pathParts = window.location.pathname.split('/');
    const token = pathParts[pathParts.length - 1];

    if (!token || token === 'proof') {
      container.innerHTML = '<div class="error-state">Invalid proof link. Please check your email for the correct link.</div>';
      return;
    }

    fetch(`/api/proof/${encodeURIComponent(token)}/data`)
      .then(r => {
        if (!r.ok) return r.json().then(d => { throw new Error(d.error || 'Not found'); });
        return r.json();
      })
      .then(data => {
        // Already approved — show confirmation
        if (data.status === 'proof_approved') {
          container.innerHTML = `
            <div class="result-message">
              <div class="result-icon">&#10003;</div>
              <h2>Your tribute is being printed</h2>
              <p>This proof was approved and your order is in production. You'll receive tracking info by email once it ships.</p>
              <p style="margin-top:var(--space-lg)"><a href="/" class="btn btn-warm">Return to Store</a></p>
            </div>`;
          return;
        }

        const total = data.totalCents ? `$${(data.totalCents / 100).toFixed(2)}` : '';
        const shortId = data.orderId.substring(0, 8).toUpperCase();
        const shipping = data.shipping;
        const shippingLine = shipping ? `${shipping.city || ''}, ${shipping.state || ''} ${shipping.zip || ''}` : '';

        const previousNotesHtml = (data.status === 'change_requested' && data.changeRequestNotes)
          ? `<div class="previous-notes"><strong>Your previous request:</strong><br>${data.changeRequestNotes.replace(/\n/g, '<br>')}</div>`
          : '';

        container.innerHTML = `
          <div class="proof-header">
            <h1>Review your design proof</h1>
            <p class="subtitle">Please review carefully before approving — this is exactly how your tribute will be printed.</p>
          </div>

          <div class="proof-image-wrap">
            <img src="${data.proofUrl}" alt="Your tribute proof" id="proofImage" />
          </div>

          ${previousNotesHtml}

          <div class="order-summary">
            <h2>Order Summary</h2>
            <div class="detail-row">
              <span class="detail-label">Order</span>
              <span class="detail-value">${shortId}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Product</span>
              <span class="detail-value">${data.sku.replace('framed-', 'Framed ').replace('x', ' x ')}"</span>
            </div>
            ${total ? `<div class="detail-row"><span class="detail-label">Total</span><span class="detail-value">${total}</span></div>` : ''}
            ${shippingLine ? `<div class="detail-row"><span class="detail-label">Ships to</span><span class="detail-value">${shippingLine}</span></div>` : ''}
          </div>

          <div class="proof-actions">
            <button class="btn-approve" id="btnApprove">Approve &amp; Print</button>
            <button class="btn-changes" id="btnChanges">Request Changes</button>
          </div>

          <div class="changes-form" id="changesForm">
            <textarea id="changesNotes" placeholder="Please describe the changes you'd like (e.g., fix a spelling, adjust the crop, change the poem text)..."></textarea>
            <button class="btn-submit-changes" id="btnSubmitChanges">Send Change Request</button>
          </div>
        `;

        // Wire up approve button
        document.getElementById('btnApprove').addEventListener('click', function() {
          if (!confirm('Are you sure you want to approve this proof? Your tribute will be sent to print.')) return;
          this.disabled = true;
          this.textContent = 'Approving...';

          fetch('/api/proof/' + encodeURIComponent(token) + '/approve', { method: 'POST' })
            .then(r => r.json())
            .then(result => {
              container.innerHTML = '<div class="result-message">' +
                '<div class="result-icon">&#10003;</div>' +
                '<h2>Your tribute is being printed!</h2>' +
                '<p>Your proof has been approved. We\'re printing your tribute on archival paper and professionally framing it now.</p>' +
                '<p style="color:var(--color-muted);margin-top:var(--space-md);">Estimated delivery: 5\u201310 business days. You\'ll receive tracking info by email.</p>' +
                '<p style="margin-top:var(--space-lg)"><a href="/" class="btn btn-warm">Return to Store</a></p>' +
                '</div>';
            })
            .catch(() => {
              this.disabled = false;
              this.textContent = 'Approve & Print';
              alert('Something went wrong. Please try again.');
            });
        });

        // Wire up changes toggle
        document.getElementById('btnChanges').addEventListener('click', function() {
          document.getElementById('changesForm').classList.toggle('visible');
        });

        // Wire up submit changes
        document.getElementById('btnSubmitChanges').addEventListener('click', function() {
          var notes = document.getElementById('changesNotes').value.trim();
          if (!notes) { alert('Please describe the changes you\'d like.'); return; }
          this.disabled = true;
          this.textContent = 'Sending...';

          fetch('/api/proof/' + encodeURIComponent(token) + '/request-changes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ notes: notes })
          })
            .then(r => r.json())
            .then(result => {
              container.innerHTML = '<div class="result-message">' +
                '<div class="result-icon">&#9998;</div>' +
                '<h2>Change request sent</h2>' +
                '<p>We\'ve received your feedback and will update your proof. You\'ll get an email when your revised proof is ready to review.</p>' +
                '<p style="margin-top:var(--space-lg)"><a href="/" class="btn btn-warm">Return to Store</a></p>' +
                '</div>';
            })
            .catch(() => {
              this.disabled = false;
              this.textContent = 'Send Change Request';
              alert('Something went wrong. Please try again.');
            });
        });
      })
      .catch(err => {
        container.innerHTML = '<div class="error-state">' + (err.message || 'Proof not found') + '. <a href="/">Return to store</a></div>';
      });
  })();
  </script>
</body>
</html>
